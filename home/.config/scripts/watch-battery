#!/usr/bin/env bash

bat_path="/sys/class/power_supply/BAT0"

bat_read() {
  status=$(cat "$bat_path/status")
  capacity=$(cat "$bat_path/capacity")
  charge_stop=$(cat "$bat_path/charge_control_end_threshold")
}

print() {
  echo "{\"status\":\"$status\",\"capacity\":$capacity,\"charge_stop\":$charge_stop}"
}

bat_read
print

while true; do
  file=$(inotifywait -qe CLOSE "$bat_path/energy_now" -e CLOSE "$bat_path/uevent" -e CLOSE_WRITE "$bat_path/charge_control_end_threshold" | cut -d' ' -f1)
  bat_read
  print
  if [[ "${file% *}" == "$bat_path/charge_control_end_threshold" ]]; then
    if [[ "$status" == "Not charging" && $capacity -lt $((charge_stop - 4)) ]]; then
      while true; do
        sleep 0.5
        bat_read
        if [[ "$status" == "Charging" || ! $capacity -lt $((charge_stop - 4)) ]]; then
          print
          break
        fi
      done
    elif [[ "$status" == "Charging" && $((charge_stop - 4)) -lt $capacity ]]; then
      while true; do
        sleep 0.5
        bat_read
        if [[ "$status" == "Not charging" || ! $((charge_stop - 4)) -lt $capacity ]]; then
          print
          break
        fi
      done
    fi
  fi
done

